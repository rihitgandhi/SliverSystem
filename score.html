<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibility Score</title>
    <link rel="stylesheet" href="./css/main.css">
</head>
<body>
    <div id="content-wrapper">
        <header role="banner">
            <nav role="navigation" aria-label="Main navigation">
                <div class="container">
                    <div class="tabs" role="tablist">
                        <a href="index.html" class="tab" role="tab" tabindex="0">‚Üê Back to Website</a>
                        <a href="chat.html" class="tab chat-tab" role="tab" tabindex="0">ü§ñ Chat with AI</a>
                        <a href="score.html" class="tab score-tab active" role="tab" tabindex="0">üìù Accessibility Score</a>
                        <a href="help.html" class="tab help-tab" role="tab" tabindex="0">‚ùì Help & Guidelines</a>
                    </div>
                </div>
            </nav>
        </header>
        <main id="main-content" role="main">
            <section class="score-section">
                <h1>Website Accessibility Score</h1>
                <form id="score-form" class="score-form">
                    <label for="url">Enter website URL:</label>
                    <input type="url" id="url" name="url" placeholder="https://example.com" required>
                    <button type="submit" id="submit-btn">
                        <span class="btn-text">Check Accessibility</span>
                        <span class="loading-spinner" style="display: none;">‚è≥</span>
                    </button>
                </form>
                <div id="error-message" class="error-message" style="display: none;"></div>
                <div id="success-message" class="success-message" style="display: none;"></div>
                <div id="results" class="results-section" style="display: none;">
                    <h2>Accessibility Analysis Results</h2>
                    <div class="score-display">
                        <div class="score-circle">
                            <span id="score-value">0</span>
                            <span class="score-label">/100</span>
                        </div>
                        <div id="score-explanation" class="score-explanation" style="display: none;"></div>
                        <div id="score-breakdown" class="score-breakdown" style="display: none;">
                            <h4>Score Breakdown</h4>
                        </div>
                        <div id="compliance-level" class="compliance-level" style="display: none;"></div>
                        <div id="next-steps" class="next-steps" style="display: none;"></div>
                    </div>
                    
                    <!-- WCAG Standards Section -->
                    <div class="wcag-standards-section">
                        <h3>WCAG 2.1 Level AA Compliance</h3>
                        <div class="standards-grid">
                            <div class="compliant-standards">
                                <h4>‚úÖ Compliant Standards</h4>
                                <div id="compliant-list" class="standards-list"></div>
                            </div>
                            <div class="non-compliant-standards">
                                <h4>‚ùå Non-Compliant Standards</h4>
                                <div id="non-compliant-list" class="standards-list"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Priority Issues Section -->
                    <div class="priority-issues-section">
                        <h3>Priority Issues</h3>
                        <div id="priority-issues-list" class="priority-issues-grid"></div>
                    </div>
                    
                    <div class="recommendations">
                        <div class="recommendation-card">
                            <h3>Short-term (1-2 weeks)</h3>
                            <p id="short-term-rec"></p>
                            <details>
                                <summary>Learn more</summary>
                                <p id="short-term-details"></p>
                            </details>
                        </div>
                        <div class="recommendation-card">
                            <h3>Medium-term (1-3 months)</h3>
                            <p id="medium-term-rec"></p>
                            <details>
                                <summary>Learn more</summary>
                                <p id="medium-term-details"></p>
                            </details>
                        </div>
                        <div class="recommendation-card">
                            <h3>Long-term (3-12 months)</h3>
                            <p id="long-term-rec"></p>
                            <details>
                                <summary>Learn more</summary>
                                <p id="long-term-details"></p>
                            </details>
                        </div>
                    </div>
                    <div class="help-link">
                        <p>Need help understanding these recommendations? <a href="help.html">View our comprehensive help guide</a></p>
                    </div>
                </div>
            </section>
        </main>
        <footer role="contentinfo">
            <div class="footer-content">
                <p>&copy; 2024 Computer Accessibility. All rights reserved.</p>
            </div>
        </footer>
    </div>
    <script>
    document.getElementById('score-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const url = document.getElementById('url').value;
        const submitBtn = document.getElementById('submit-btn');
        const btnText = submitBtn.querySelector('.btn-text');
        const loadingSpinner = submitBtn.querySelector('.loading-spinner');
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        
        if (!url) {
            showError('Please enter a URL');
            return;
        }
        
        // Validate URL format
        try {
            new URL(url);
        } catch (e) {
            showError('Please enter a valid URL (e.g., https://example.com)');
            return;
        }
        
        // Clear previous messages and hide results
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        resultsDiv.style.display = 'none';
        
        // Show loading state
        btnText.textContent = 'Analyzing...';
        loadingSpinner.style.display = 'inline';
        submitBtn.disabled = true;
        
        try {
            // More robust backend URL detection
            let backendUrl;
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            console.log('Current hostname:', hostname);
            console.log('Current protocol:', protocol);
            console.log('Current origin:', window.location.origin);
            
            if (hostname.includes('github.io') || hostname.includes('github.com')) {
                backendUrl = 'https://sliversystem-backend.onrender.com';
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                backendUrl = 'http://localhost:5000';
            } else {
                backendUrl = window.location.origin;
            }
            
            console.log('Detected backend URL:', backendUrl);
            
            const requestData = { url: url };
            console.log('Sending request to:', `${backendUrl}/api/score`);
            console.log('Request data:', requestData);
            
            const response = await fetch(`${backendUrl}/api/score`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);
            
            if (response.ok) {
                // Display results
                document.getElementById('score-value').textContent = data.score;
                
                // Display score explanation if available
                if (data.score_explanation) {
                    const scoreExplanationDiv = document.getElementById('score-explanation');
                    if (scoreExplanationDiv) {
                        scoreExplanationDiv.textContent = data.score_explanation;
                        scoreExplanationDiv.style.display = 'block';
                    }
                }
                
                // Display score breakdown if available
                if (data.score_breakdown) {
                    const scoreBreakdownDiv = document.getElementById('score-breakdown');
                    if (scoreBreakdownDiv) {
                        scoreBreakdownDiv.innerHTML = `
                            <div class="breakdown-item">
                                <span class="breakdown-label">Critical Issues:</span>
                                <span class="breakdown-value">${data.score_breakdown.critical_issues}/40</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Structural Issues:</span>
                                <span class="breakdown-value">${data.score_breakdown.structural_issues}/30</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Content Issues:</span>
                                <span class="breakdown-value">${data.score_breakdown.content_issues}/20</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Technical Issues:</span>
                                <span class="breakdown-value">${data.score_breakdown.technical_issues}/10</span>
                            </div>
                        `;
                        scoreBreakdownDiv.style.display = 'block';
                    }
                }
                
                // Display compliance level if available
                if (data.compliance_level) {
                    const complianceLevelDiv = document.getElementById('compliance-level');
                    if (complianceLevelDiv) {
                        complianceLevelDiv.textContent = data.compliance_level;
                        complianceLevelDiv.style.display = 'block';
                    }
                }
                
                // Display next steps if available
                if (data.next_steps) {
                    const nextStepsDiv = document.getElementById('next-steps');
                    if (nextStepsDiv) {
                        nextStepsDiv.textContent = data.next_steps;
                        nextStepsDiv.style.display = 'block';
                    }
                }
                
                document.getElementById('short-term-rec').textContent = data.recommendations.short_term;
                document.getElementById('medium-term-rec').textContent = data.recommendations.medium_term;
                document.getElementById('long-term-rec').textContent = data.recommendations.long_term;
                document.getElementById('short-term-details').textContent = data.details.short_term;
                document.getElementById('medium-term-details').textContent = data.details.medium_term;
                document.getElementById('long-term-details').textContent = data.details.long_term;
                
                // Display WCAG Standards
                displayWCAGStandards(data.wcag_standards);
                
                // Display Priority Issues
                displayPriorityIssues(data.priority_issues);
                
                showSuccess('Analysis completed successfully!');
                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                showError('Error: ' + (data.error || 'Failed to analyze website'));
            }
        } catch (error) {
            console.error('Error:', error);
            console.error('Error details:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
            
            if (error.message.includes('Unexpected token')) {
                showError('Error: Received HTML instead of JSON. This usually means the request went to the wrong server. Please try again.');
            } else if (error.message.includes('Failed to fetch')) {
                showError('Error: Failed to connect to server. Please check your internet connection and try again.');
            } else {
                showError('Error: ' + error.message);
            }
        } finally {
            // Reset button
            btnText.textContent = 'Check Accessibility';
            loadingSpinner.style.display = 'none';
            submitBtn.disabled = false;
        }
    });
    
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        successDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    function displayWCAGStandards(wcagData) {
        const compliantList = document.getElementById('compliant-list');
        const nonCompliantList = document.getElementById('non-compliant-list');
        
        // Clear previous content
        compliantList.innerHTML = '';
        nonCompliantList.innerHTML = '';
        
        // Display compliant standards
        if (wcagData.compliant && wcagData.compliant.length > 0) {
            wcagData.compliant.forEach(criterion => {
                const item = document.createElement('div');
                item.className = 'standard-item compliant';
                item.innerHTML = `
                    <strong>${criterion}</strong>
                    <span>${wcagData.details[criterion] || 'Compliant'}</span>
                `;
                compliantList.appendChild(item);
            });
        } else {
            compliantList.innerHTML = '<p class="no-standards">No compliant standards found</p>';
        }
        
        // Display non-compliant standards
        if (wcagData.non_compliant && wcagData.non_compliant.length > 0) {
            wcagData.non_compliant.forEach(criterion => {
                const item = document.createElement('div');
                item.className = 'standard-item non-compliant';
                item.innerHTML = `
                    <strong>${criterion}</strong>
                    <span>${wcagData.details[criterion] || 'Non-compliant'}</span>
                `;
                nonCompliantList.appendChild(item);
            });
        } else {
            nonCompliantList.innerHTML = '<p class="no-standards">All standards are compliant!</p>';
        }
    }
    
    function displayPriorityIssues(priorityIssues) {
        const issuesList = document.getElementById('priority-issues-list');
        
        // Clear previous content
        issuesList.innerHTML = '';
        
        if (priorityIssues && priorityIssues.length > 0) {
            priorityIssues.forEach(issue => {
                const issueCard = document.createElement('div');
                issueCard.className = 'priority-issue-card';
                
                // Build the card content with new fields
                let cardContent = `
                    <div class="issue-header">
                        <h4>${issue.title}</h4>
                        <span class="wcag-criterion">WCAG ${issue.wcag_criterion}</span>
                    </div>
                    <p class="issue-description">${issue.description}</p>
                    <div class="issue-metrics">
                        <span class="impact ${issue.impact.toLowerCase()}">Impact: ${issue.impact}</span>
                        <span class="effort ${issue.effort.toLowerCase()}">Effort: ${issue.effort}</span>
                `;
                
                // Add severity if available
                if (issue.severity) {
                    cardContent += `<span class="severity ${issue.severity.toLowerCase()}">Severity: ${issue.severity}</span>`;
                }
                
                cardContent += '</div>';
                
                // Add affected elements if available
                if (issue.affected_elements) {
                    cardContent += `<div class="affected-elements"><strong>Affected:</strong> ${issue.affected_elements}</div>`;
                }
                
                // Add fix example if available
                if (issue.fix_example) {
                    cardContent += `<div class="fix-example"><strong>Fix Example:</strong> <code>${issue.fix_example}</code></div>`;
                }
                
                // Add estimated time if available
                if (issue.estimated_time) {
                    cardContent += `<div class="estimated-time"><strong>Estimated Time:</strong> ${issue.estimated_time}</div>`;
                }
                
                cardContent += '</div>';
                issueCard.innerHTML = cardContent;
                issuesList.appendChild(issueCard);
            });
        } else {
            issuesList.innerHTML = '<p class="no-issues">No priority issues identified</p>';
        }
    }
    </script>
</body>
</html> 